#!/usr/bin/env node

const { program } = require('commander');
const path = require('path');
const fs = require('fs');

// è·å–ç‰ˆæœ¬ä¿¡æ¯
const packageJson = require(path.join(__dirname, '..', 'package.json'));

program
  .name('torna-mcp')
  .description('Torna MCP Server - é€šè¿‡MCPåè®®æä¾›Torna APIæ–‡æ¡£æœåŠ¡')
  .version(packageJson.version);

program
  .command('start')
  .description('å¯åŠ¨Torna MCPæœåŠ¡å™¨')
  .option('-u, --url <url>', 'Torna API URL')
  .option('-t, --token <token>', 'Torna API Token')
  .option('-p, --project <projectId>', 'Torna Project ID (å¯é€‰)')
  .action((options) => {
    // è®¾ç½®ç¯å¢ƒå˜é‡
    if (options.url) process.env.TORNA_API_URL = options.url;
    if (options.token) process.env.TORNA_API_TOKEN = options.token;
    if (options.project) process.env.TORNA_PROJECT_ID = options.project;

    // æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
    if (!process.env.TORNA_API_URL || !process.env.TORNA_API_TOKEN) {
      console.error('âŒ é”™è¯¯: å¿…é¡»æä¾›TORNA_API_URLå’ŒTORNA_API_TOKEN');
      console.error('');
      console.error('ä½¿ç”¨æ–¹æ³•:');
      console.error('  torna-mcp start -u <API_URL> -t <API_TOKEN> [-p <PROJECT_ID>]');
      console.error('');
      console.error('æˆ–è€…è®¾ç½®ç¯å¢ƒå˜é‡:');
      console.error('  export TORNA_API_URL="https://your-torna-instance.com"');
      console.error('  export TORNA_API_TOKEN="your_token_here"');
      console.error('  export TORNA_PROJECT_ID="your_project_id" # å¯é€‰');
      console.error('  torna-mcp start');
      process.exit(1);
    }

    console.error('ğŸš€ å¯åŠ¨Torna MCPæœåŠ¡å™¨...');
    console.error(`ğŸ“¡ API URL: ${process.env.TORNA_API_URL}`);
    console.error(`ğŸ”‘ Token: ${process.env.TORNA_API_TOKEN.substring(0, 8)}...`);
    if (process.env.TORNA_PROJECT_ID) {
      console.error(`ğŸ“ Project ID: ${process.env.TORNA_PROJECT_ID}`);
    }
    console.error('');

    // å¯åŠ¨MCPæœåŠ¡å™¨
    require(path.join(__dirname, '..', 'mcp-server.js'));
  });

program
  .command('config')
  .description('ç”ŸæˆMCPé…ç½®æ–‡ä»¶ç¤ºä¾‹')
  .option('-o, --output <file>', 'è¾“å‡ºæ–‡ä»¶è·¯å¾„', 'mcp-config.json')
  .action((options) => {
    const configTemplate = {
      mcpServers: {
        "torna-mcp": {
          command: "npx",
          args: ["torna-mcp", "start"],
          env: {
            TORNA_API_URL: "https://your-torna-instance.com",
            TORNA_API_TOKEN: "your-api-token-here",
            TORNA_PROJECT_ID: "your-project-id-here"
          }
        }
      }
    };

    try {
      fs.writeFileSync(options.output, JSON.stringify(configTemplate, null, 2));
      console.log(`âœ… MCPé…ç½®æ–‡ä»¶å·²ç”Ÿæˆ: ${options.output}`);
      console.log('');
      console.log('è¯·ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œæ›¿æ¢ä¸ºä½ çš„å®é™…Tornaé…ç½®ä¿¡æ¯ï¼š');
      console.log('- TORNA_API_URL: Tornaå®ä¾‹çš„APIåœ°å€');
      console.log('- TORNA_API_TOKEN: Torna APIè®¿é—®ä»¤ç‰Œ');
      console.log('- TORNA_PROJECT_ID: Tornaé¡¹ç›®IDï¼ˆå¯é€‰ï¼‰');
    } catch (error) {
      console.error('âŒ ç”Ÿæˆé…ç½®æ–‡ä»¶å¤±è´¥:', error.message);
      process.exit(1);
    }
  });

program
  .command('test')
  .description('æµ‹è¯•Tornaè¿æ¥')
  .option('-u, --url <url>', 'Torna API URL')
  .option('-t, --token <token>', 'Torna API Token')
  .option('-p, --project <projectId>', 'Torna Project ID (å¯é€‰)')
  .action(async (options) => {
    // è®¾ç½®ç¯å¢ƒå˜é‡
    if (options.url) process.env.TORNA_API_URL = options.url;
    if (options.token) process.env.TORNA_API_TOKEN = options.token;
    if (options.project) process.env.TORNA_PROJECT_ID = options.project;

    // æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
    if (!process.env.TORNA_API_URL || !process.env.TORNA_API_TOKEN) {
      console.error('âŒ é”™è¯¯: å¿…é¡»æä¾›TORNA_API_URLå’ŒTORNA_API_TOKEN');
      process.exit(1);
    }

    console.log('ğŸ” æµ‹è¯•Tornaè¿æ¥...');

    try {
      const { getAllApiDocs } = require(path.join(__dirname, '..', 'src', 'services', 'tornaService'));
      const config = {
        apiUrl: process.env.TORNA_API_URL,
        apiToken: process.env.TORNA_API_TOKEN,
        projectId: process.env.TORNA_PROJECT_ID,
      };

      const result = await getAllApiDocs(null, 5, config);
      console.log('âœ… è¿æ¥æˆåŠŸ!');
      console.log(`ğŸ“Š æ‰¾åˆ° ${result.length} ä¸ªAPIæ¥å£`);

      if (result.length > 0) {
        console.log('');
        console.log('å‰å‡ ä¸ªAPIæ¥å£:');
        result.slice(0, 3).forEach((api, index) => {
          console.log(`  ${index + 1}. ${api.name || api.title || 'Unnamed API'}`);
        });
      }
    } catch (error) {
      console.error('âŒ è¿æ¥å¤±è´¥:', error.message);
      process.exit(1);
    }
  });

// å¦‚æœæ²¡æœ‰æä¾›å‘½ä»¤ï¼Œæ˜¾ç¤ºå¸®åŠ©
if (process.argv.length <= 2) {
  program.help();
}

program.parse();
